<div id="experience-container">
    <h2>Experience</h2>
    <div id="experience-list"></div>
    <template id="experience-template">
        <div class="experience-block" data-index="__INDEX__">
            <%- include('../components/forms/selectInput.ejs', {
                fieldName: "experience[__INDEX__][company]",
                fieldLabel: "Company",
                fieldValue: companies.length?String(companies[0]._id):"",
                fieldOptions: companies.map(company=>{return {value: String(company._id), label: company.name}})
            })%>
            <div class="field">
                <label>Job Title</label>
                <input type="text" name="experience[__INDEX__][title]" required>
            </div>
            <div class="field">
                <label>Start Date</label>
                <input type="month" name="experience[__INDEX__][startDate]" required>
            </div>
            <div class="field">
                <label>End Date</label>
                <input type="month" name="experience[__INDEX__][endDate]" required>
            </div>
            <div class="field">
                <label>Description</label>
                <textarea name="experience[__INDEX__][description]" required></textarea>
            </div>

            <button type="button" class="remove-experience" style="display:none;">Remove</button>
            <hr />
        </div>
    </template>
    <button type="button" id="add-experience">+ Add another experience</button>
    <script defer>
        const experienceList = document.querySelector('#experience-list');
        const addBtn = document.querySelector('#add-experience');
        const template = document.querySelector('#experience-template');

        function getNextIndex() {
            const blocks = experienceList.querySelectorAll('.experience-block');
            return blocks.length; // simple: next index is count
        }

        function addExperienceBlock() {
            const nextIndex = getNextIndex();

            // clone template content (DocumentFragment)
            const fragment = template.content.cloneNode(true);

            // update names: replace "__INDEX__" with the number
            fragment.querySelectorAll('[name]').forEach((el) => {
            el.name = el.name.replaceAll('__INDEX__', nextIndex);
            });

            // set data-index too (optional but useful)
            const block = fragment.querySelector('.experience-block');
            block.dataset.index = nextIndex;

            experienceList.appendChild(fragment);
        }

        // Event delegation so it works for dynamically added buttons
        experienceList.addEventListener('click', (e) => {
            if (e.target.classList.contains('remove-experience')) {
            const block = e.target.closest('.experience-block');
            block.remove();

            // Optional: re-index after removing so the array indexes are contiguous
            reindexExperienceBlocks();
            }
        });

        function reindexExperienceBlocks() {
            const blocks = experienceList.querySelectorAll('.experience-block');

            blocks.forEach((block, newIndex) => {
                block.dataset.index = newIndex;

                block.querySelectorAll('[name]').forEach((el) => {
                    // Replace the old index inside experience[OLD] with experience[NEW]
                    el.name = el.name.replace(/experience\[\d+\]/, `experience[${newIndex}]`);
                });
            });

            // If only one block remains, hide its remove button (nice UX)
            blocks.forEach((block, i) => {
            const removeBtn = block.querySelector('.remove-experience');
            if (!removeBtn) return;
            removeBtn.style.display = blocks.length === 1 ? 'none' : 'inline-block';
            });
        }

        addBtn.addEventListener('click', () => {
            addExperienceBlock();
            reindexExperienceBlocks(); // ensures remove button visibility logic stays right
        });

        // Add first experience block
        addExperienceBlock();

        // Initialize remove button visibility for initial load
        reindexExperienceBlocks();
    </script>
</div>