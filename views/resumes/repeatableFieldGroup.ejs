<script defer>
  function initRepeatableGroup(container) {
    const groupName = container.dataset.group; // e.g., "experience"
    const list = container.querySelector(".repeatable-list");
    const addBtn = container.querySelector(".repeatable-add");
    const template = container.querySelector(".repeatable-template");
    const blockClass = "repeatable-block";
    const removeClass = "repeatable-remove";

    function getNextIndex() {
      return list.querySelectorAll(`.${blockClass}`).length;
    }

    function addBlock() {
      const nextIndex = getNextIndex();
      const fragment = template.content.cloneNode(true);

      fragment.querySelectorAll("[name]").forEach((el) => {
        el.name = el.name.replaceAll("__INDEX__", nextIndex);
      });

      const block = fragment.querySelector(`.${blockClass}`);
      block.dataset.index = nextIndex;
      list.appendChild(fragment);
    }

    function hydrateBlock(block, data, index) {
      block.querySelectorAll("[name]").forEach((el) => {
        const match = el.name.match(/\[(\w+)\]$/); // extract field name
        if (!match) return;
        const fieldName = match[1];

        if (data[fieldName] !== undefined) {
          if (el.tagName === "SELECT") {
            el.value = String(data[fieldName]);
          } else if (el.type === "month" && data[fieldName]) {
            // Convert Date to YYYY-MM
            const date = new Date(data[fieldName]);
            el.value = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, "0")}`;
          } else {
            el.value = data[fieldName] || "";
          }
        }
      });
    }

    list.addEventListener("click", (e) => {
      if (e.target.classList.contains(removeClass)) {
        e.target.closest(`.${blockClass}`).remove();
        reindexBlocks();
      }
    });

    function reindexBlocks() {
      const blocks = list.querySelectorAll(`.${blockClass}`);
      const groupRegex = new RegExp(`${groupName}\\[\\d+\\]`);

      blocks.forEach((block, newIndex) => {
        block.dataset.index = newIndex;
        block.querySelectorAll("[name]").forEach((el) => {
          el.name = el.name.replace(groupRegex, `${groupName}[${newIndex}]`);
        });
      });

      blocks.forEach((block) => {
        const removeBtn = block.querySelector(`.${removeClass}`);
        if (removeBtn) {
          removeBtn.style.display =
            blocks.length === 1 ? "none" : "inline-block";
        }
      });
    }

    addBtn.addEventListener("click", () => {
      addBlock();
      reindexBlocks();
    });

    // Check if blocks already exist (edit mode)
    const existingBlocks = list.querySelectorAll(`.${blockClass}`);

    if (existingBlocks.length === 0) {
      // New mode: add one empty block
      addBlock();
    }

    // Always run reindex to ensure remove buttons are shown/hidden correctly
    reindexBlocks();
  }

  // Auto-initialize all repeatable groups on the page
  document.querySelectorAll("[data-group]").forEach(initRepeatableGroup);

  //   const experienceList = document.querySelector("#experience-list");
  //   const addBtn = document.querySelector("#add-experience");
  //   const template = document.querySelector("#experience-template");

  //   function getNextIndex() {
  //     const blocks = experienceList.querySelectorAll(".experience-block");
  //     return blocks.length; // simple: next index is count
  //   }

  //   function addExperienceBlock() {
  //     const nextIndex = getNextIndex();

  //     // clone template content (DocumentFragment)
  //     const fragment = template.content.cloneNode(true);

  //     // update names: replace "__INDEX__" with the number
  //     fragment.querySelectorAll("[name]").forEach((el) => {
  //       el.name = el.name.replaceAll("__INDEX__", nextIndex);
  //     });

  //     // set data-index too (optional but useful)
  //     const block = fragment.querySelector(".experience-block");
  //     block.dataset.index = nextIndex;

  //     experienceList.appendChild(fragment);
  //   }

  //   // Event delegation so it works for dynamically added buttons
  //   experienceList.addEventListener("click", (e) => {
  //     if (e.target.classList.contains("remove-experience")) {
  //       const block = e.target.closest(".experience-block");
  //       block.remove();

  //       // Optional: re-index after removing so the array indexes are contiguous
  //       reindexExperienceBlocks();
  //     }
  //   });

  //   function reindexExperienceBlocks() {
  //     const blocks = experienceList.querySelectorAll(".experience-block");

  //     blocks.forEach((block, newIndex) => {
  //       block.dataset.index = newIndex;

  //       block.querySelectorAll("[name]").forEach((el) => {
  //         // Replace the old index inside experience[OLD] with experience[NEW]
  //         el.name = el.name.replace(
  //           /experience\[\d+\]/,
  //           `experience[${newIndex}]`,
  //         );
  //       });
  //     });

  //     // If only one block remains, hide its remove button (nice UX)
  //     blocks.forEach((block, i) => {
  //       const removeBtn = block.querySelector(".remove-experience");
  //       if (!removeBtn) return;
  //       removeBtn.style.display = blocks.length === 1 ? "none" : "inline-block";
  //     });
  //   }

  //   addBtn.addEventListener("click", () => {
  //     addExperienceBlock();
  //     reindexExperienceBlocks(); // ensures remove button visibility logic stays right
  //   });

  //   // Add first experience block
  //   addExperienceBlock();

  //   // Initialize remove button visibility for initial load
  //   reindexExperienceBlocks();
</script>
